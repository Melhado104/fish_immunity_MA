---
title: "literature_summary"
author: "Gabriel Melhado"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## *Load packages*
```{r}
rm(list = ls())

pacman::p_load(tidyverse,
               here,
               kableExtra,
               magrittr, 
               patchwork,
               metafor,
               metagear,
               ape,
               rotl,
               orchaRd,
               clubSandwich,
               MuMIn,
               ggsankey)

```

## *Load Data*
```{r}
data <- read_csv(here("data", "data_pharma_immune.csv"), skip = 0)

# Format ID variables as characters
data <- mutate_at(data, 
                  vars(study_id, 
                       exposure_id, 
                       assay_id), 
                       as.character)
# Table of the dataset
 kable(data, "html") %>%
    kable_styling("bordered", position = "left") %>%
    scroll_box(width = "250%", height = "800px")


# Summary of the data set
kable(summary(data), "html") %>%
    kable_styling("bordered", position = "left") %>%
    scroll_box(width = "250%", height = "500px")
```

# **Data exploration and reporting of methodological items**
# A bubble plot showing the number of effect sizes of each pharmaceutical_class_class class per immune trait
```{r,fig.width=8, fig.height=13}
# Summarize data by grouping on pharmaceutical_class and immune trait measured, then count entries.
pc_cb_summary <- data %>% 
  group_by(pharmaceutical_class, immune_category_high) %>% 
  summarise(n = n(), .groups = "drop")

# Determine the top 9 pharmaceutical_classs based on the number of records.
top_pharmaceutical_class <- pc_cb_summary %>%
  group_by(pharmaceutical_class) %>%
  summarise(total_count = sum(n)) %>%
  top_n(9, total_count) %>%
  pull(pharmaceutical_class)

# Adjust category names to 'Other' for those pharmaceutical classes not in the top 9
pc_cb_summary_filtered <- pc_cb_summary %>%
  mutate(pharmaceutical_class = ifelse(pharmaceutical_class %in% top_pharmaceutical_class,
                                           pharmaceutical_class,
                                           "Other")) %>%
  group_by(pharmaceutical_class, immune_category_high) %>%
  summarise(n = sum(n), .groups = "drop")

# Create the bubble plot
immune_pharmaceutical_class_bubble_plot <- pc_cb_summary_filtered %>%
  ggplot(aes(
    x = fct_rev(fct_reorder(str_wrap(str_to_title(immune_category_high), width = 12), n, .fun = "sum")),
    y = fct_reorder(str_to_title(pharmaceutical_class), n, .fun = "sum"),
    size = n
  )) +
  geom_point(alpha = 0.5, color = RColorBrewer::brewer.pal(n = 8, name = "Dark2")[3]) +
  geom_text(aes(label = as.character(n)), size = 5, color = "gray10") +
  scale_size_continuous(range = c(5, 20), guide = "none") +
  scale_x_discrete(expand = expansion(mult = 0.08)) +
  scale_y_discrete(expand = expansion(mult = 0.08)) +
  theme_bw() +
  theme(
    legend.position = "none",
    axis.text = element_text(size = 12, color = "black"),
    axis.title = element_text(size = 12, face = "bold", color = "black"),
    plot.caption = element_text(size = 12, color = "gray10", face = "italic"),
    plot.margin = margin(6, 6, 6, 6),
    aspect.ratio = 0.7  
  ) +
  labs(x = "Immune trait",
    y = "Pharmaceutical class")

#ggsave("immune_pharma_bubble.png", immune_pharmaceutical_class_bubble_plot, width = 9, height = 5, units = "in", dpi = 300)


## A bar chart showing the total number of effect sizes per species
# Group data by species, count entries, and drop groups post-summary.
sp_summary <- data %>% 
  group_by(species_english) %>% 
  summarise(n = n(), .groups = "drop")

# Calculate proportion and percentage of total counts for each species.
species_pct <- sp_summary %>% 
  mutate(proportion = n / sum(n), 
         percentage = proportion * 100)

# Create the bar plot
species_effect_size_count_bar_plot <- sp_summary %>%
  ggplot(aes(x = n, y = reorder(str_to_title(species_english), n))) + 
  geom_bar(stat = "identity", width = 0.8, alpha = 0.5, fill = RColorBrewer::brewer.pal(n = 8, name = "Dark2")[2]) +
  geom_text(aes(label = ifelse(n < 9, "", n), x = n / 2, y = reorder(str_to_title(species_english), n)), hjust = 0.5, size = 5, color = "black") +
  geom_text(data = species_pct, aes(label = paste0("(", round(percentage, 1), "%)"), x = n), 
            hjust = -0.1, size = 6, color = "black", fontface = "bold") +
  scale_x_continuous(expand = c(0, 0), limits = c(0, max(sp_summary$n) * 1.2)) +
  theme_bw() +
  guides(size = "none") +
  theme(legend.position = "none",
        axis.text = element_text(size = 12,color = "black"),
        axis.title = element_text(size = 12,face = "bold", color = "black"),
        plot.caption = element_text(size = 12, color = "gray10", face = "italic")) +
  labs(caption = "The value in each bar is the total number of effect sizes",
       x = "Total number of effect size estimates",
       y = "Species")


print(immune_pharmaceutical_class_bubble_plot)
print(species_effect_size_count_bar_plot)

```

# A bubble plot showing the number of effect sizes of each fish family
```{r}
# --- Summarise counts per fish family ---
family_summary <- data %>%
  group_by(fish_family) %>%
  summarise(
    k = n(),
    .groups = "drop"
  ) %>%
  mutate(
    proportion = k / sum(k),
    percentage = proportion * 100,
    family_label = str_to_title(fish_family),
    label_pct = paste0("(", round(percentage, 1), "%)"),
    label_x_inside = k * 0.5,
    pct_x_position = k + max(k) * 0.15
  )

# --- Plot ---
family_effect_size_count_bar_plot <- family_summary %>%
  ggplot(aes(x = k, y = reorder(family_label, k))) +
  
  geom_col(
    width = 0.8,
    alpha = 0.7,
    fill = "#8FBCE6",
    color = "black",
    linewidth = 0.3
  ) +
  
  # Print k inside bar
  geom_text(
    aes(x = label_x_inside, label = k),
    size = 4,
    color = "black"
  ) +
  
  # Print percentage outside
  geom_text(
    aes(x = pct_x_position, label = label_pct),
    size = 4,
    fontface = "bold",
    color = "black"
  ) +
  
  scale_x_continuous(
    expand = c(0, 0),
    limits = c(0, max(family_summary$k) * 1.35)
  ) +
  
  theme_pub_large +
  theme(
    legend.position = "none"
  ) +
  
  labs(
    x = "Total number of effect size estimates (k)",
    y = "Fish families")

family_effect_size_count_bar_plot

#ggsave(filename = here::here("figures", "Figures2_summary_family.pdf"), plot = family_effect_size_count_bar_plot, device = cairo_pdf, width = 120, height = 70, units = "mm", scale = 2, dpi = 800)

#ggsave(filename = here::here("figures", "Figures2_summary_family.jpg"), plot = family_effect_size_count_bar_plot, width = 120, height = 70, units = "mm", scale = 2, dpi = 800)
```


# A bubble plot showing the number of effect sizes of each immune trait
```{r}
## A bar chart showing the total number of effect sizes per immune trait
# --- Summarise counts per immune trait ---
immune_summary <- data %>%
  group_by(immune_category_high) %>%
  summarise(
    k = n(),                          # number of effect sizes
    studies = n_distinct(study_id),   # number of studies
    spp = n_distinct(species_latin),  # number of species
    .groups = "drop"
  ) %>%
  mutate(
    proportion = k / sum(k),
    percentage = proportion * 100,
    immune_label = str_to_title(immune_category_high),
    label_in_bar = paste0("k=", k, "\nstudies=", studies, "\nspp=", spp),
    label_pct = paste0("(", round(percentage, 1), "%)"),
    
    # Only move the k/studies/spp label outside for Cell-Mediated
    is_cell = immune_label == "Cell-Mediated",
    
    # x positions
    label_x_inside  = k * 0.5,
    label_x_outside = k + max(k) * 0.03,
    pct_x_position  = k + max(k) * 0.28
  )

# --- Plot ---
immune_effect_size_count_bar_plot <- immune_summary %>%
  ggplot(aes(x = k, y = reorder(immune_label, k))) +
  geom_col(
    width = 0.8,
    alpha = 0.7,
    fill = "#8FBCE6",
    color = "black",
    linewidth = 0.3
  ) +
  
  # Labels INSIDE (all except Cell-Mediated)
  geom_text(
    data = subset(immune_summary, !is_cell),
    aes(x = label_x_inside, label = label_in_bar),
    size = 3.6,
    color = "black",
    lineheight = 0.95
  ) +
  
  # Label OUTSIDE only for Cell-Mediated
  geom_text(
    data = subset(immune_summary, is_cell),
    aes(x = label_x_outside, label = label_in_bar),
    hjust = 0,
    size = 3.6,
    color = "black"
  ) +
  
  # Percentages (pushed further right)
  geom_text(
    aes(label = label_pct, x = pct_x_position),
    size = 4,
    fontface = "bold",
    color = "black"
  ) +
  
  scale_x_continuous(
    expand = c(0, 0),
    limits = c(0, max(immune_summary$k) * 1.45)
  ) +
  
  theme_pub_large +
  theme(
    legend.position = "none"
  ) +
  
  labs(
    x = "Total number of effect size estimates (k)",
    y = "Immune traits")

immune_effect_size_count_bar_plot

#ggsave(filename = here::here("figures", "Figures1_summary_immune.pdf"), plot = immune_effect_size_count_bar_plot, device = cairo_pdf, width = 120, height = 70, units = "mm", scale = 2, dpi = 800)

#ggsave(filename = here::here("figures", "Figures1_summary_immune.jpg"), plot = immune_effect_size_count_bar_plot, width = 120, height = 70, units = "mm", scale = 2, dpi = 800)

```

#A bubble plot showing the number of effect sizes of each species per immune trait
```{r,fig.width=8, fig.height=6}
# Group data by species, count entries, and drop groups post-summary.
species_summary <- data %>%
  group_by(species_english, immune_category_high) %>%
  summarise(
    n = n(),
    pharmaceutical_class = first(pharmaceutical_class),
    .groups = "drop"
  )

# Determine the top 20 species based on the number of records.
top_species <- species_summary %>%
  group_by(species_english, immune_category_high) %>%
  summarise(total_count = sum(n), .groups = "drop") %>%
  top_n(20, total_count) %>%
  pull(species_english)

# Create the bubble plot the immune trait assessed per species (number of effect size as count)

immune_species_bubble_plot <- species_summary %>% # can add _filtered if needed
  ggplot(aes(x = fct_rev(fct_reorder(str_to_title(immune_category_high), n, .fun = 'sum')),
             y = fct_reorder(str_to_title(species_english), n, .fun = 'sum'),
             size = n)) +
  geom_point(alpha = 0.5, color = RColorBrewer::brewer.pal(n = 8, name = "Dark2")[2]) +
  scale_size_continuous(range = c(8, 25)) +
  theme_bw() +
  guides(size = "none") +
theme(legend.position = "none",
        axis.text = element_text(color = "black"),
        axis.title = element_text(face = "bold", color = "black"),
        plot.caption = element_text(size = 10, color = "gray10", face = "italic")) + 
  geom_text(aes(label = as.character(n)), size = 4, color = "gray10") +
  labs(caption = "The value in each cell is the number of effect sizes",
       x = "Immune trait",
       y = "Species") +
  scale_color_brewer(palette = "Dark2", name = "Chemical Class")

print(immune_species_bubble_plot)

# ggsave(here("figures", "immune_species_bubble_plot.pdf"), width = 8, height = 6, units = "cm", scale = 2, dpi = 800)
# ggsave(here("figures", "immune_species_bubble_plot.jpg"), width = 8, height = 6, units = "cm", scale = 2, dpi = 800)
```


# A bar chart showing the sex of fish used in the literature
```{r,fig.width=10, fig.height=5}
# --- Summarise counts per fish sex ---
sex_summary <- data %>%
  group_by(sex) %>%
  summarise(
    k = n(),            # number of effect sizes (or rows)
    .groups = "drop"
  ) %>%
  mutate(
    sex_label = str_to_title(sex),
    proportion = k / sum(k),
    percentage = proportion * 100,
    label_pct = paste0("(", round(percentage, 1), "%)"),
    label_x_inside = k * 0.5,
    pct_x_position = k + max(k) * 0.15
  )

# --- Plot (publication style, consistent with other supplementary bar charts) ---
fish_sex_study_count_bar_plot <- sex_summary %>%
  ggplot(aes(x = k, y = reorder(sex_label, k))) +
  geom_col(
    width = 0.8,
    alpha = 0.7,
    fill = "#8FBCE6",
    color = "black",
    linewidth = 0.3
  ) +
  # k inside bar
  geom_text(
    aes(x = label_x_inside, label = k),
    size = 4,
    color = "black"
  ) +
  # percentage outside bar
  geom_text(
    aes(x = pct_x_position, label = label_pct),
    size = 4,
    fontface = "bold",
    color = "black"
  ) +
  scale_x_continuous(
    expand = c(0, 0),
    limits = c(0, max(sex_summary$k) * 1.35)
  ) +
  theme_pub_large +
  theme(legend.position = "none") +
  labs(
    x = "Total number of effect sizes (k)",
    y = "Sex of fish")

fish_sex_study_count_bar_plot

ggsave(filename = here::here("figures", "Figures3_sex_immune.pdf"), plot = fish_sex_study_count_bar_plot, device = cairo_pdf, width = 120, height = 70, units = "mm", scale = 2, dpi = 800)

ggsave(filename = here::here("figures", "Figures3_sex_immune.jpg"), plot = fish_sex_study_count_bar_plot, width = 120, height = 70, units = "mm", scale = 2, dpi = 800)
```

## A bubble plot showing the number of effect sizes of each pharmaceutical per immune trait
```{r,fig.width=8, fig.height=8}
# Group data by species, count entries, and drop groups post-summary.
p_cb_summary <- data %>%
  group_by(pharmaceutical, immune_category_high) %>%
  summarise(
    n = n(),
    pharmaceutical = first(pharmaceutical),
    .groups = "drop"
  )
# Determine the top 8 pesticide classes based on the number of records.
top_pharmaceutical <- p_cb_summary %>%
  group_by(pharmaceutical, immune_category_high) %>%
  summarise(total_count = sum(n), .groups = "drop") %>%
  top_n(20, total_count) %>%
  pull(pharmaceutical)

# Create the bubble plot for the immune traits assessed per pharmaceutical (effect size as count)

immune_pharmaceutical_bubble_plot <- p_cb_summary %>% # can add _filtered if needed
   ggplot(aes(x = fct_rev(fct_reorder(str_to_title(immune_category_high), n, .fun = 'sum')),
             y = fct_reorder(str_to_title(pharmaceutical), n, .fun = 'sum'),
             size = n)) +
  geom_point(alpha = 0.5, color = RColorBrewer::brewer.pal(n = 8, name = "Dark2")[5]) +
  scale_size_continuous(range = c(4, 20)) +
  theme_bw() +
  guides(size = "none") +
theme(legend.position = "none",
        axis.text = element_text(color = "black"),
        axis.title = element_text(face = "bold", color = "black"),
        plot.caption = element_text(size = 10, color = "gray10", face = "italic")) +
  geom_text(aes(label = as.character(n)), size = 4, color = "gray10") +
  labs(caption = "The value in each cell is the number of effect sizes",
       x = "Immune trait",
       y = "Pharmaceutical") +
      scale_y_discrete(labels = function(x) ifelse(x %in% c("Ddt", "Dca", "Dcpmu"), toupper(x), x))

print(immune_pharmaceutical_bubble_plot)

# ggsave(here("figures", "immune_pharmaceutical_bubble_plot.pdf"), width = 8, height = 12, units = "cm", scale = 2, dpi = 800)
# ggsave(here("figures", "immune_pharmaceutical_bubble_plot.jpg"), width = 8, height = 12, units = "cm", scale = 2, dpi = 800)
```

# Visual representation of the characteristics of the primary studies included in the dataset. The vertical bars indicate key categorical variables. The widths of the vertical bars indicate the numbers of effect sizes represented by each level of the categorical variable. The flow lines between vertical bars indicate the connections and overlaps of different levels of the categorical variables. 
```{r}
# Select relevant columns and replace NA values with "Not Reported"
data_sankey <- data %>%
  select(c(immune_category_high, 
           pharmaceutical_class, 
           species_english, 
           sex)) %>%
  mutate(across(c(immune_category_high, 
           pharmaceutical_class, 
           species_english, 
           sex), 
                ~ replace_na(., "Not Reported")))

# Transform data into a long format for the Sankey plot
sankey_df <- data_sankey %>%
  ggsankey::make_long(immune_category_high, 
           pharmaceutical_class, 
           species_english, 
           sex)

# Create the Sankey plot
ggplot(sankey_df, aes(x = x, next_x = next_x, 
                      node = node, 
                      next_node = next_node, 
                      fill = factor(node), 
                      label = node)) +
  geom_sankey(flow.alpha = .6, node.color = "gray30") +
  geom_sankey_label(size = 3, color = "white", fill = "gray40") +
  scale_fill_viridis_d() +
  scale_x_discrete(labels = c("Immune trait", "Pharmaceutical Class", 
                              "Species", "Sex"), 
                   position = "top") +
  theme_sankey(base_size = 10) +
  labs(x = NULL) +
  theme(legend.position = "none",
        plot.title = element_text(hjust = .5),
        axis.text.x = element_text(color = "black", size = 9))


# ggsave(here("figures", "sankey_plot.pdf"), width = 10, height = 5, units = "cm", scale = 2, dpi = 800)
# ggsave(here("figures", "sankey_plot.jpg"), width = 10, height = 5, units = "cm", scale = 2, dpi = 800)

```
